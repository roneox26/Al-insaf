<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>গ্রাহক বিবরণ - {{ customer.name }}</title>
    <style>
        @media print {
            .no-print { display: none; }
            body { margin: 0; padding: 5mm; }
            .header { background: #fff !important; color: #000 !important; border: 2px solid #000 !important; }
            .section-title { background: #fff !important; color: #000 !important; border: 1px solid #000 !important; }
            .collection-header { background: #fff !important; color: #000 !important; border: 1px solid #000 !important; }
            .collection-table th { background: #fff !important; color: #000 !important; }
            .info-cell.label { background: #fff !important; color: #000 !important; font-weight: bold !important; }
            .summary-box { background: #fff !important; color: #000 !important; border: 2px solid #000 !important; }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Kalpurush', 'SolaimanLipi', Arial, sans-serif;
            padding: 10px;
            background: #fff;
        }
        
        .container {
            max-width: 210mm;
            margin: 0 auto;
            border: 2px solid #000;
            background: #fff;
        }
        
        .header {
            text-align: center;
            padding: 15px;
            border-bottom: 3px solid #000;
            background: #fff;
            color: #000;
        }
        
        .header h2 {
            font-size: 22px;
            margin-bottom: 3px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-section {
            display: grid;
            grid-template-columns: 3fr 1fr;
            border-bottom: 2px solid #000;
        }
        
        .left-panel {
            border-right: 2px solid #000;
        }
        
        .section-title {
            background: #fff;
            color: #000;
            padding: 8px 10px;
            border-bottom: 2px solid #000;
            font-weight: bold;
            font-size: 14px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }
        
        .info-cell {
            border-right: 1px solid #000;
            border-bottom: 1px solid #000;
            padding: 5px 6px;
            font-size: 11px;
            min-height: 26px;
        }
        
        .info-cell:nth-child(4n) {
            border-right: none;
        }
        
        .info-cell.label {
            background: #fff;
            font-weight: 600;
            color: #000;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
        }
        
        .staff-section {
            border-bottom: 1px solid #000;
            padding: 6px;
        }
        
        .staff-row {
            display: grid;
            grid-template-columns: 60px 1fr;
            margin-bottom: 2px;
            font-size: 10px;
        }
        
        .staff-row label {
            font-weight: bold;
        }
        
        .photo-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        
        .photo-box {
            width: 90px;
            height: 110px;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        
        .photo-box img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .summary-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            border-bottom: 2px solid #000;
            background: #f8f9fa;
        }
        
        .summary-box {
            border-right: 1px solid #000;
            padding: 12px;
            text-align: center;
            background: #fff;
            color: #000;
        }
        
        .summary-box:nth-child(1),
        .summary-box:nth-child(2),
        .summary-box:nth-child(3),
        .summary-box:nth-child(4),
        .summary-box:nth-child(5) {
            background: #fff;
            color: #000;
        }
        
        .summary-box:last-child {
            border-right: none;
        }
        
        .summary-label {
            font-size: 11px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .summary-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .collection-section {
            padding: 10px;
        }
        
        .collection-header {
            background: #fff;
            color: #000;
            padding: 8px 10px;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #000;
        }
        
        .collection-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .collection-table th {
            background: #fff;
            color: #000;
            border: 1px solid #000;
            padding: 8px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .collection-table td {
            border: 1px solid #000;
            padding: 6px;
            text-align: center;
            font-size: 11px;
        }
        
        .print-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .print-btn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="no-print" style="text-align: center; margin-bottom: 10px;">
        <button class="print-btn" onclick="window.print()">🖨️ সম্পূর্ণ প্রিন্ট</button>
        <button class="print-btn" style="background: #4CAF50;" onclick="printDetails()">📄 শুধু বিবরণ প্রিন্ট</button>
        <button class="print-btn" style="background: #FF9800;" onclick="printHistory()">📊 শুধু হিস্ট্রি প্রিন্ট</button>
        <button class="print-btn" style="background: #666;" onclick="window.history.back()">← ফিরে যান</button>
    </div>

    <script>
        function printDetails() {
            document.querySelector('.collection-section').style.display = 'none';
            window.print();
            document.querySelector('.collection-section').style.display = 'block';
        }
        function printHistory() {
            document.querySelector('.main-section').style.display = 'none';
            document.querySelector('.summary-section').style.display = 'none';
            document.querySelector('.customer-info-header').style.display = 'block';
            window.print();
            document.querySelector('.main-section').style.display = 'grid';
            document.querySelector('.summary-section').style.display = 'grid';
            document.querySelector('.customer-info-header').style.display = 'none';
        }
    </script>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h2>গ্রাহক বিবরণ</h2>
            <div class="customer-info-header" style="display: none; font-size: 14px; margin-top: 5px;">
                <span>সদস্যের নাম: <strong>{{ customer.name }}</strong></span> | 
                <span>সদস্য নং: <strong>{{ customer.member_no or 'N/A' }}</strong></span>
            </div>
        </div>

        <!-- Main Section -->
        <div class="main-section">
            <!-- Left Panel: Customer Details -->
            <div class="left-panel">
                <div class="section-title">গ্রাহকের বিবরণ</div>
                <div class="info-grid">
                    <div class="info-cell label">নাম</div>
                    <div class="info-cell">{{ customer.name }}</div>
                    <div class="info-cell label">সদস্যা নং</div>
                    <div class="info-cell">{{ customer.member_no or '' }}</div>
                    
                    <div class="info-cell label">পিতা/স্বামী</div>
                    <div class="info-cell">{{ customer.father_husband or '' }}</div>
                    <div class="info-cell label">মোবাইল</div>
                    <div class="info-cell">{{ customer.phone }}</div>
                    
                    <div class="info-cell label">পেশা</div>
                    <div class="info-cell">{{ customer.profession or '' }}</div>
                    <div class="info-cell label">NID</div>
                    <div class="info-cell">{{ customer.nid_no or '' }}</div>
                    
                    <div class="info-cell label">গ্রাম</div>
                    <div class="info-cell">{{ customer.village or '' }}</div>
                    <div class="info-cell label">পোস্ট</div>
                    <div class="info-cell">{{ customer.post or '' }}</div>
                    
                    <div class="info-cell label">থানা</div>
                    <div class="info-cell">{{ customer.thana or '' }}</div>
                    <div class="info-cell label">জেলা</div>
                    <div class="info-cell">{{ customer.district or '' }}</div>
                    
                    <div class="info-cell label">জামিনদার</div>
                    <div class="info-cell">{{ customer.granter or '' }}</div>
                    <div class="info-cell label">ভর্তি ফি</div>
                    <div class="info-cell">{{ "{:,.0f}".format(admission_fee) if admission_fee else '০' }}</div>
                    
                    <div class="info-cell label">ঠিকানা</div>
                    <div class="info-cell" style="grid-column: span 3;">{{ customer.address or '' }}</div>
                    
                    <div class="info-cell label">মোবাইল জামিনদার</div>
                    <div class="info-cell"></div>
                    <div class="info-cell label">কল্যাণ</div>
                    <div class="info-cell">{{ "{:,.0f}".format(welfare_fee) if welfare_fee else '০' }}</div>
                    
                    <div class="info-cell label">অভি:ফোন নং</div>
                    <div class="info-cell"></div>
                    <div class="info-cell label">আবেদন ফি</div>
                    <div class="info-cell">{{ "{:,.0f}".format(application_fee) if application_fee else '০' }}</div>
                    
                    <div class="info-cell label">লোন বিতরণ তারিখ</div>
                    <div class="info-cell">{{ loan_date }}</div>
                    <div class="info-cell label">মোট টাকা</div>
                    <div class="info-cell">{{ "{:,.0f}".format(loan_principal) }}{% if interest_rate > 0 %} + {{ "{:.1f}".format(interest_rate) }}% ({{ "{:,.0f}".format(interest_amount) }}){% endif %} = {{ "{:,.0f}".format(loan_principal + interest_amount) }}</div>
                    
                    <div class="info-cell label">কিস্তি ধরন</div>
                    <div class="info-cell">সাপ্তাহিক</div>
                    <div class="info-cell label">সঞ্চয় ব্যালেন্স</div>
                    <div class="info-cell">{{ "{:,.0f}".format(actual_savings_balance) }}</div>
                    
                    <div class="info-cell label">কিস্তি সংখ্যা</div>
                    <div class="info-cell">{{ installment_count }}</div>
                    <div class="info-cell label">কিস্তি নং</div>
                    <div class="info-cell">{{ "{:,.0f}".format(weekly_installment) }}</div>
                    
                    <div class="info-cell label">শেষ তারিখ</div>
                    <div class="info-cell">{{ loan_end_date }}</div>
                    <div class="info-cell label">মোট বকেয়া</div>
                    <div class="info-cell">{{ "{:,.0f}".format(actual_remaining if actual_remaining is defined else customer.remaining_loan) }}</div>
                </div>
            </div>

            <!-- Right Panel: Staff & Photo -->
            <div class="right-panel">
                <div class="section-title">স্টাফ</div>
                <div class="staff-section">
                    <div class="staff-row">
                        <label>কর্মকর্তা:</label>
                        <span>{{ staff.name if staff else '' }}</span>
                    </div>
                    <div class="staff-row">
                        <label>শাখা:</label>
                        <span>প্রধান শাখা</span>
                    </div>
                    <div class="staff-row">
                        <label>তারিখ:</label>
                        <span>{{ now.strftime('%d-%m-%Y') }}</span>
                    </div>
                </div>
                <div class="section-title">ছবি</div>
                <div class="photo-section">
                    <div class="photo-box">
                        {% if customer.photo %}
                        <img src="{{ url_for('static', filename='uploads/' + customer.photo) }}" alt="ছবি">
                        {% else %}
                        <span style="color: #999;">ছবি নেই</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <div class="summary-box">
                <div class="summary-label">মোট ঋণ</div>
                <div class="summary-value">{{ "{:,.0f}".format(total_loan_disbursed) }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-label">মোট সঞ্চয়</div>
                <div class="summary-value">{{ "{:,.0f}".format(total_savings) }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-label">মোট বিতরণ আদায়</div>
                <div class="summary-value">{{ "{:,.0f}".format(total_loan_collected) }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-label">মোট বকেয়া</div>
                <div class="summary-value">{{ "{:,.0f}".format(actual_remaining if actual_remaining is defined else customer.remaining_loan) }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-label">সঞ্চয় ব্যালেন্স</div>
                <div class="summary-value">{{ "{:,.0f}".format(actual_savings_balance) }}</div>
            </div>
        </div>

        <!-- Collection History -->
        <div class="collection-section">
            <div class="collection-header" style="background: #2196F3; color: white;">
                কালেকশন হিস্ট্রি
            </div>
            <table class="collection-table">
                <thead>
                    <tr>
                        <th>তারিখ</th>
                        <th>ঋণ</th>
                        <th>সঞ্চয়</th>
                        <th>মোট কিস্তি</th>
                        <th>মোট সঞ্চয়</th>
                        <th>বাকি</th>
                    </tr>
                </thead>
                <tbody>
                    {% if loans_with_collections and loans_with_collections|length > 0 %}
                        {% set running_total = namespace(value=0) %}
                        {% set running_saving = namespace(value=0) %}
                        {% set total_loan_amount = (total_loan_disbursed + total_interest) if total_interest is defined else total_loan_disbursed %}
                        
                        {% for loan_item in loans_with_collections %}
                            {% for item in loan_item.collections %}
                                {% set running_total.value = running_total.value + item.loan_amount %}
                                {% if item.saving_amount > 0 %}
                                    {% set running_saving.value = running_saving.value + item.saving_amount %}
                                {% endif %}
                                
                                <tr>
                                    <td>{{ item.collection.collection_date.strftime('%d-%m-%y') }}</td>
                                    <td>{{ "{:,.0f}".format(item.loan_amount) if item.loan_amount > 0 else '' }}</td>
                                    <td>{{ "{:,.0f}".format(item.saving_amount) if item.saving_amount > 0 else '' }}</td>
                                    <td>{{ "{:,.0f}".format(running_total.value) }}</td>
                                    <td>{{ "{:,.0f}".format(running_saving.value) }}</td>
                                    <td>{{ "{:,.0f}".format(total_loan_amount - running_total.value) }}</td>
                                </tr>
                            {% endfor %}
                        {% endfor %}
                        
                        <!-- Add empty rows to fill space -->
                        {% set total_rows = namespace(value=0) %}
                        {% for loan_item in loans_with_collections %}
                            {% set total_rows.value = total_rows.value + loan_item.collections|length %}
                        {% endfor %}
                        {% for i in range(10 - total_rows.value) %}
                        <tr>
                            <td style="height: 28px;">&nbsp;</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for i in range(10) %}
                        <tr>
                            <td style="height: 28px;">&nbsp;</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
