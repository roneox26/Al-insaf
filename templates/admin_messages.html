<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ðŸ’¬ Messages - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #0a4d68 0%, #05BFDB 100%); font-family: 'Segoe UI', system-ui, sans-serif; }
    .chat-container { height: 100vh; max-width: 1600px; margin: 0 auto; background: #0a1929; display: flex; box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
    .chat-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 130px; background: linear-gradient(135deg, #0a4d68 0%, #05BFDB 100%); z-index: 0; }
    
    /* Sidebar */
    .chat-sidebar { width: 380px; border-right: 1px solid rgba(5, 191, 219, 0.2); display: flex; flex-direction: column; background: rgba(10, 25, 41, 0.95); position: relative; z-index: 1; }
    .sidebar-header { padding: 20px; background: rgba(10, 25, 41, 0.95); backdrop-filter: blur(10px); color: white; border-bottom: 1px solid rgba(5, 191, 219, 0.2); }
    .sidebar-header h5 { margin: 0; font-weight: 600; }
    .search-box { padding: 15px; background: rgba(10, 25, 41, 0.95); border-bottom: 1px solid rgba(5, 191, 219, 0.2); }
    .search-box input { border-radius: 20px; border: 1px solid rgba(5, 191, 219, 0.3); padding: 10px 20px; width: 100%; background: rgba(255, 255, 255, 0.05); color: #fff; }
    .search-box input::placeholder { color: rgba(255, 255, 255, 0.4); }
    .user-list { flex: 1; overflow-y: auto; }
    .user-item { padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: all 0.3s; display: flex; align-items: center; background: transparent; }
    .user-item:hover { background: rgba(5, 191, 219, 0.1); transform: translateX(5px); }
    .user-item.active { background: rgba(5, 191, 219, 0.2); border-left: 3px solid #05BFDB; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #05BFDB 0%, #00d9ff 100%); color: #0a1929; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; flex-shrink: 0; box-shadow: 0 4px 15px rgba(5, 191, 219, 0.4); border: 2px solid rgba(5, 191, 219, 0.3); }
    .info { flex: 1; margin-left: 15px; min-width: 0; }
    .name { font-weight: 600; color: #fff; font-size: 16px; }
    .last-msg { font-size: 13px; color: rgba(255, 255, 255, 0.5); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .time { font-size: 11px; color: rgba(255, 255, 255, 0.4); }
    .badge { background: #05BFDB; color: #0a1929; border-radius: 50%; padding: 3px 8px; font-size: 11px; font-weight: bold; }
    
    /* Chat Area */
    .chat-main { flex: 1; display: flex; flex-direction: column; }
    .chat-header { padding: 15px 20px; background: rgba(10, 25, 41, 0.95); backdrop-filter: blur(10px); color: white; display: flex; align-items: center; position: relative; z-index: 10; border-bottom: 1px solid rgba(5, 191, 219, 0.2); }
    .chat-header .avatar { width: 45px; height: 45px; font-size: 20px; margin-right: 12px; }
    .header-info { flex: 1; }
    .header-info h6 { margin: 0; font-weight: 600; font-size: 17px; }
    .header-info small { opacity: 0.7; font-size: 13px; }
    .header-actions { display: flex; gap: 8px; }
    .header-actions .btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(5, 191, 219, 0.15); border: 1px solid rgba(5, 191, 219, 0.3); color: #05BFDB; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
    .header-actions .btn:hover { background: rgba(5, 191, 219, 0.25); transform: scale(1.05); box-shadow: 0 0 20px rgba(5, 191, 219, 0.3); }
    
    /* Messages */
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #0a1929; position: relative; z-index: 1; }
    .message { margin-bottom: 16px; display: flex; animation: messageSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes messageSlide { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .message.sent { justify-content: flex-end; }
    .message.received { justify-content: flex-start; }
    .message-bubble { max-width: 60%; padding: 10px 14px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); word-wrap: break-word; position: relative; }
    .message.sent .message-bubble { background: linear-gradient(135deg, #05BFDB 0%, #00d9ff 100%); color: #0a1929; border-bottom-right-radius: 4px; font-weight: 500; }
    .message.received .message-bubble { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; border-bottom-left-radius: 4px; }
    .message-content { line-height: 1.5; font-size: 15px; }
    .message-time { font-size: 10px; margin-top: 4px; display: flex; align-items: center; gap: 4px; opacity: 0.7; }
    .message.sent .message-time { justify-content: flex-end; color: rgba(10, 25, 41, 0.7); }
    .message.received .message-time { color: rgba(255, 255, 255, 0.5); }
    
    /* Voice Message */
    .voice-message { display: flex; align-items: center; gap: 10px; min-width: 200px; }
    .voice-play-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(10, 25, 41, 0.3); border: none; color: #0a1929; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
    .voice-play-btn:hover { transform: scale(1.1); }
    .message.received .voice-play-btn { background: rgba(5, 191, 219, 0.3); color: #05BFDB; }
    .voice-waveform { flex: 1; height: 28px; display: flex; align-items: center; gap: 2px; }
    .voice-waveform span { width: 3px; background: rgba(10, 25, 41, 0.5); border-radius: 2px; animation: wave 1s ease-in-out infinite; }
    .message.received .voice-waveform span { background: rgba(5, 191, 219, 0.6); }
    @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
    
    /* Input */
    .chat-input { padding: 15px 20px; background: rgba(10, 25, 41, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(5, 191, 219, 0.2); }
    .input-wrapper { display: flex; gap: 10px; align-items: center; }
    .input-actions { display: flex; gap: 6px; }
    .input-actions .btn { width: 42px; height: 42px; border-radius: 50%; border: none; background: rgba(5, 191, 219, 0.15); color: #05BFDB; transition: all 0.3s; border: 1px solid rgba(5, 191, 219, 0.3); }
    .input-actions .btn:hover { background: rgba(5, 191, 219, 0.25); transform: scale(1.05); }
    #messageInput { flex: 1; border: 1px solid rgba(5, 191, 219, 0.3); border-radius: 24px; padding: 12px 18px; font-size: 15px; background: rgba(255, 255, 255, 0.05); color: #fff; }
    #messageInput::placeholder { color: rgba(255, 255, 255, 0.4); }
    #messageInput:focus { outline: none; border-color: #05BFDB; box-shadow: 0 0 0 3px rgba(5, 191, 219, 0.15); }
    #sendBtn { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #05BFDB 0%, #00d9ff 100%); border: none; color: #0a1929; transition: all 0.3s; box-shadow: 0 4px 15px rgba(5, 191, 219, 0.4); }
    #sendBtn:hover { transform: scale(1.05); }
    
    /* Recording UI */
    .recording-ui { display: none; align-items: center; gap: 12px; padding: 12px 18px; background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%); border-radius: 24px; color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
    .recording-ui.active { display: flex; }
    .recording-dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .recording-time { font-weight: 600; flex: 1; }
    .recording-cancel { background: white; color: #ff4757; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; }
    
    /* Empty State */
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.5); }
    .empty-state i { font-size: 70px; margin-bottom: 15px; opacity: 0.3; }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(5, 191, 219, 0.5); border-radius: 10px; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-sidebar">
      <div class="sidebar-header">
        <h5><i class="fas fa-comments"></i> Messages</h5>
        <small>Staff Conversations</small>
      </div>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ðŸ” Search staff..." onkeyup="filterStaff()">
      </div>
      <div class="user-list">
        {% for item in staff_data %}
        <a href="{{ url_for('view_messages', user_id=item.user.id) }}" class="text-decoration-none">
          <div class="user-item {% if selected_user and selected_user.id == item.user.id %}active{% endif %}" data-name="{{ item.user.name.lower() }}">
            <div class="avatar">{{ item.user.name[0].upper() }}</div>
            <div class="info">
              <div class="d-flex justify-content-between">
                <div class="name">{{ item.user.name }}</div>
                {% if item.last_time %}<div class="time">{{ item.last_time.strftime('%H:%M') }}</div>{% endif %}
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="last-msg">{{ item.last_message or 'No messages' }}</div>
                {% if item.unread > 0 %}<span class="badge">{{ item.unread }}</span>{% endif %}
              </div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>

    <div class="chat-main">
      {% if selected_user %}
      <div class="chat-header">
        <div class="avatar">{{ selected_user.name[0].upper() }}</div>
        <div class="header-info">
          <h6>{{ selected_user.name }}</h6>
          <small><i class="fas fa-circle text-success"></i> Online</small>
        </div>
        <div class="header-actions">
          <button class="btn" title="Voice Call"><i class="fas fa-phone"></i></button>
          <button class="btn" title="Video Call"><i class="fas fa-video"></i></button>
          <a href="{{ url_for('dashboard') }}" class="btn"><i class="fas fa-times"></i></a>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        {% for msg in messages %}
        <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
          <div class="message-bubble">
            {% if msg.file_path %}
              {% if msg.file_type == 'image' %}
              <img src="{{ url_for('static', filename='uploads/' + msg.file_path) }}" style="max-width:300px;border-radius:10px;cursor:pointer;display:block" onclick="window.open(this.src)">
              {% else %}
              <a href="{{ url_for('static', filename='uploads/' + msg.file_path) }}" target="_blank" style="color:inherit"><i class="fas fa-file"></i> {{ msg.content }}</a>
              {% endif %}
            {% elif msg.content.startswith('VOICE:') %}
            <div class="voice-message">
              <button class="voice-play-btn"><i class="fas fa-play"></i></button>
              <div class="voice-waveform"><span></span><span></span><span></span><span></span><span></span></div>
              <span>0:{{ msg.content[6:] }}s</span>
            </div>
            {% else %}
            <div class="message-content">{{ msg.content }}</div>
            {% endif %}
            <div class="message-time">{{ msg.created_date.strftime('%H:%M') }} {% if msg.sender_id == current_user.id %}<i class="fas fa-check-double"></i>{% endif %}</div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="chat-input">
        <form id="messageForm" class="input-wrapper">
          <input type="hidden" name="receiver_id" value="{{ selected_user.id }}">
          <div class="input-actions">
            <button type="button" class="btn" onclick="toggleEmoji()"><i class="fas fa-smile"></i></button>
            <button type="button" class="btn" onclick="attachFile()"><i class="fas fa-paperclip"></i></button>
            <button type="button" class="btn" onmousedown="startRecording()" onmouseup="stopRecording()"><i class="fas fa-microphone"></i></button>
          </div>
          <input type="text" id="messageInput" name="content" placeholder="Type a message..." autocomplete="off">
          <button type="submit" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
        </form>
        <div class="recording-ui" id="recordingUI">
          <div class="recording-dot"></div>
          <span class="recording-time" id="recordingTime">0:00</span>
          <button class="recording-cancel" onclick="cancelRecording()">Cancel</button>
        </div>
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <h4>Select a staff to start messaging</h4>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary mt-3"><i class="fas fa-arrow-left"></i> Back</a>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    {% if selected_user %}
    const receiverId = {{ selected_user.id }};
    const chatMessages = document.getElementById('chatMessages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    let mediaRecorder, audioChunks = [], recordingInterval, recordingSeconds = 0;

    function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }
    scrollToBottom();

    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = messageInput.value.trim();
      if (!content) return;
      const formData = new FormData(messageForm);
      try {
        const response = await fetch('{{ url_for("send_message") }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData });
        const data = await response.json();
        if (data.success) { addMessage(data.message, true); messageInput.value = ''; }
      } catch (error) { console.error(error); }
    });

    function addMessage(msg, isSent) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      let content = '';
      if (msg.file_path && msg.file_type === 'image') {
        content = `<img src="/static/uploads/${msg.file_path}" style="max-width:300px;border-radius:10px;cursor:pointer;display:block" onclick="window.open(this.src)">`;
      } else if (msg.file_path) {
        content = `<a href="/static/uploads/${msg.file_path}" target="_blank" style="color:inherit"><i class="fas fa-file"></i> ${msg.content}</a>`;
      } else {
        content = `<div class="message-content">${msg.content}</div>`;
      }
      msgDiv.innerHTML = `<div class="message-bubble">${content}<div class="message-time">${msg.created_date}${isSent ? ' <i class="fas fa-check-double"></i>' : ''}</div></div>`;
      chatMessages.appendChild(msgDiv);
      scrollToBottom();
    }

    async function startRecording() {
      try {
        if (!navigator.mediaDevices?.getUserMedia) { alert('ðŸŽ¤ Not supported!'); return; }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = []; recordingSeconds = 0;
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.start();
        document.getElementById('recordingUI').classList.add('active');
        messageForm.style.display = 'none';
        recordingInterval = setInterval(() => {
          recordingSeconds++;
          document.getElementById('recordingTime').textContent = `0:${recordingSeconds.toString().padStart(2, '0')}`;
        }, 1000);
      } catch (error) { alert('ðŸŽ¤ Microphone access denied!'); }
    }

    function stopRecording() {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
      mediaRecorder.stop();
      clearInterval(recordingInterval);
      mediaRecorder.onstop = async () => {
        const formData = new FormData();
        formData.append('receiver_id', receiverId);
        formData.append('content', `VOICE:${recordingSeconds}`);
        const response = await fetch('{{ url_for("send_message") }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData });
        const data = await response.json();
        if (data.success) addMessage(data.message, true);
        document.getElementById('recordingUI').classList.remove('active');
        messageForm.style.display = 'flex';
      };
    }

    function cancelRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); clearInterval(recordingInterval); }
      document.getElementById('recordingUI').classList.remove('active');
      messageForm.style.display = 'flex';
    }

    function toggleEmoji() {
      const emojis = ['ðŸ˜Š', 'ðŸ˜‚', 'â¤ï¸', 'ðŸ‘', 'ðŸŽ‰', 'ðŸ”¥'];
      messageInput.value += emojis[Math.floor(Math.random() * emojis.length)];
      messageInput.focus();
    }

    function attachFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,.pdf,.doc,.docx';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 10 * 1024 * 1024) { alert('ðŸ“Ž Max 10MB!'); return; }
        const formData = new FormData();
        formData.append('receiver_id', receiverId);
        formData.append('file', file);
        formData.append('content', '');
        try {
          const response = await fetch('{{ url_for("send_message") }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData });
          const data = await response.json();
          if (data.success) addMessage(data.message, true);
        } catch (error) { alert('Failed!'); }
      };
      input.click();
    }

    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    setInterval(async () => {
      try {
        const response = await fetch(`/message/get_new/${receiverId}?last_id=${lastMessageId}`);
        const data = await response.json();
        if (data.messages?.length > 0) {
          data.messages.forEach(msg => { addMessage(msg, false); lastMessageId = msg.id; });
        }
      } catch (error) { console.error(error); }
    }, 3000);
    {% endif %}

    function filterStaff() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.user-item').forEach(item => {
        item.parentElement.style.display = item.getAttribute('data-name').includes(input) ? 'block' : 'none';
      });
    }
  </script>
</body>
</html>
