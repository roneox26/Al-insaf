<!doctype html>
<html lang="bn">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta charset="utf-8">
  <title>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .schedule-card { border-left: 4px solid #007bff; }
    .schedule-card.today { border-left-color: #28a745; background: #f0fff4; }
    .schedule-card.overdue { border-left-color: #dc3545; background: #fff5f5; }
    .schedule-card.upcoming { border-left-color: #ffc107; background: #fffbf0; }
    .badge-today { background: #28a745; }
    .badge-overdue { background: #dc3545; }
    .badge-upcoming { background: #ffc107; color: #000; }
    .badge-collected { background: #6c757d; }
  </style>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
</head>
<body class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>üìÖ ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤</h3>
    <div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚¨ÖÔ∏è ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
      <button onclick="window.print()" class="btn btn-primary no-print">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="card mb-3 no-print">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</label>
          <select name="date_filter" class="form-select" onchange="this.form.submit()">
            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>‡¶Ü‡¶ú</option>
            <option value="tomorrow" {% if date_filter == 'tomorrow' %}selected{% endif %}>‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤</option>
            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>‡¶è‡¶á ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π</option>
            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏</option>
            <option value="overdue" {% if date_filter == 'overdue' %}selected{% endif %}>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</option>
            <option value="all" {% if date_filter == 'all' %}selected{% endif %}>‡¶∏‡¶¨</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</label>
          <select name="status_filter" class="form-select" onchange="this.form.submit()">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>‡¶∏‡¶¨</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç</option>
            <option value="collected" {% if status_filter == 'collected' %}selected{% endif %}>‡¶∏‡¶Ç‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§</option>
            <option value="missed" {% if status_filter == 'missed' %}selected{% endif %}>‡¶Æ‡¶ø‡¶∏‡¶°</option>
          </select>
        </div>
        {% if current_user.role == 'admin' %}
        <div class="col-md-3">
          <label class="form-label">‡¶∏‡ßç‡¶ü‡¶æ‡¶´</label>
          <select name="staff_filter" class="form-select" onchange="this.form.submit()">
            <option value="">‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡¶æ‡¶´</option>
            {% for staff in all_staff %}
            <option value="{{ staff.id }}" {% if staff_filter == staff.id|string %}selected{% endif %}>{{ staff.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-3">
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h6>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®</h6>
          <h3>{{ today_count }} ‡¶ü‡¶ø</h3>
          <p class="mb-0">‡ß≥{{ "{:,.0f}".format(today_amount) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h6>‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π</h6>
          <h3>{{ week_count }} ‡¶ü‡¶ø</h3>
          <p class="mb-0">‡ß≥{{ "{:,.0f}".format(week_amount) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-danger">
        <div class="card-body">
          <h6>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</h6>
          <h3>{{ overdue_count }} ‡¶ü‡¶ø</h3>
          <p class="mb-0">‡ß≥{{ "{:,.0f}".format(overdue_amount) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h6>‡¶Æ‡ßã‡¶ü ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç</h6>
          <h3>{{ total_pending }} ‡¶ü‡¶ø</h3>
          <p class="mb-0">‡ß≥{{ "{:,.0f}".format(total_pending_amount) }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule List -->
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üìã ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ({{ schedules|length }} ‡¶ü‡¶ø)</h5>
    </div>
    <div class="card-body">
      {% if schedules %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
              <th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</th>
              <th>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡¶Ç</th>
              <th>‡¶´‡ßã‡¶®</th>
              <th>‡¶ü‡¶æ‡¶á‡¶™</th>
              <th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
              <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
              <th>‡¶∏‡ßç‡¶ü‡¶æ‡¶´</th>
              <th class="no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
          </thead>
          <tbody>
            {% for schedule in schedules %}
            <tr class="{% if schedule.status == 'collected' %}table-secondary{% elif schedule.days_diff < 0 %}table-danger{% elif schedule.days_diff == 0 %}table-success{% endif %}">
              <td>
                {{ schedule.scheduled_date.strftime('%d-%m-%Y') }}
                {% if schedule.days_diff < 0 %}
                <span class="badge badge-overdue">{{ schedule.days_diff|abs }} ‡¶¶‡¶ø‡¶® ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</span>
                {% elif schedule.days_diff == 0 %}
                <span class="badge badge-today">‡¶Ü‡¶ú</span>
                {% elif schedule.days_diff <= 7 %}
                <span class="badge badge-upcoming">{{ schedule.days_diff }} ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</span>
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('customer_details', id=schedule.customer.id) }}">{{ schedule.customer.name }}</a>
              </td>
              <td>{{ schedule.customer.member_no }}</td>
              <td>{{ schedule.customer.phone }}</td>
              <td>
                {% if schedule.collection_type == 'loan' %}
                <span class="badge bg-primary">‡¶≤‡ßã‡¶®</span>
                {% else %}
                <span class="badge bg-info">‡¶∏‡ßá‡¶≠‡¶ø‡¶Ç‡¶∏</span>
                {% endif %}
              </td>
              <td>‡ß≥{{ "{:,.0f}".format(schedule.expected_amount) }}</td>
              <td>
                {% if schedule.status == 'collected' %}
                <span class="badge badge-collected">‚úì ‡¶∏‡¶Ç‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§</span>
                {% elif schedule.status == 'missed' %}
                <span class="badge bg-danger">‚úó ‡¶Æ‡¶ø‡¶∏‡¶°</span>
                {% elif schedule.status == 'rescheduled' %}
                <span class="badge bg-warning text-dark">‚ü≥ ‡¶∞‡¶ø‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤</span>
                {% else %}
                <span class="badge bg-secondary">‚è≥ ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç</span>
                {% endif %}
              </td>
              <td>{{ schedule.customer.staff.name if schedule.customer.staff else 'N/A' }}</td>
              <td class="no-print">
                {% if schedule.status == 'pending' %}
                <a href="{{ url_for('collect_loan') }}?customer_id={{ schedule.customer.id }}" class="btn btn-sm btn-success">üí∞ ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü</a>
                <button class="btn btn-sm btn-warning" onclick="reschedule({{ schedule.id }})">‚ü≥</button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤ ‡¶®‡ßá‡¶á</div>
      {% endif %}
    </div>
  </div>

  <script>
    function reschedule(scheduleId) {
      const newDate = prompt('‡¶®‡¶§‡ßÅ‡¶® ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡¶ø‡¶® (YYYY-MM-DD):');
      if (newDate) {
        fetch(`/collection_schedule/reschedule/${scheduleId}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({new_date: newDate})
        }).then(response => {
          if (response.ok) {
            location.reload();
          }
        });
      }
    }
  </script>
</body>
</html>
