<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>💰 Loan Collection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .customer-card { transition: all 0.3s; position: relative; }
    .customer-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important; }
    .customer-card.collected { background: #d4edda !important; border: 2px solid #28a745 !important; opacity: 0.7; }
    .customer-card.collected::after { content: '✓ সংগৃহীত'; position: absolute; top: 10px; right: 10px; background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
    @media (max-width: 768px) {
      .card-body { padding: 1rem; }
      h5 { font-size: 1rem; }
      .btn { font-size: 0.85rem; padding: 0.5rem 1rem; }
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-brand">💰 Loan Collection</span>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">← Back to Dashboard</a>
  </nav>

  <div class="container mt-3 pb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">💰 লোন কালেকশন</h4>
      <input type="text" id="searchBox" class="form-control w-50" placeholder="🔍 খুঁজুন...">
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if customers %}
      <div class="row mt-2">
        {% for customer in customers %}
          <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card shadow customer-card" data-id="{{ customer.id }}" data-name="{{ customer.name }}" data-phone="{{ customer.phone }}">
              <div class="card-body">
                <h5 class="card-title mb-2"><i class="fas fa-user"></i> {{ customer.name }}</h5>
                <p class="mb-1 small"><i class="fas fa-phone"></i> {{ customer.phone }}</p>
                <p class="mb-1 small"><i class="fas fa-map-marker-alt"></i> {{ customer.address[:30] }}...</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <div>
                    <small class="text-muted">মোট লোন</small><br>
                    <strong>৳{{ "{:,.0f}".format(customer.total_loan) }}</strong>
                  </div>
                  <div class="text-end">
                    <small class="text-muted">বাকি</small><br>
                    <strong class="text-danger">৳{{ "{:,.0f}".format(customer.remaining_loan) }}</strong>
                  </div>
                </div>
                <button class="btn btn-success w-100 mt-3" data-bs-toggle="modal" data-bs-target="#collectModal{{ customer.id }}">
                  <i class="fas fa-hand-holding-usd"></i> কালেকশন করুন
                </button>
              </div>
            </div>
          </div>

          <!-- Collection Modal -->
          <div class="modal fade" id="collectModal{{ customer.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title"><i class="fas fa-hand-holding-usd"></i> {{ customer.name }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('collect_loan') }}" class="collection-form" data-customer-id="{{ customer.id }}">
                  <div class="modal-body">
                    <input type="hidden" name="customer_id" value="{{ customer.id }}">
                    <div class="alert alert-info mb-3">
                      <strong>বাকি লোন:</strong> ৳{{ "{:,.2f}".format(customer.remaining_loan) }}
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold">কালেকশন অ্যামাউন্ট (৳)</label>
                      <input type="number" step="0.01" name="amount" class="form-control form-control-lg" required max="{{ customer.remaining_loan }}" placeholder="অ্যামাউন্ট দিন">
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i> সম্পন্ন করুন</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info mt-4">
        কোনো কাস্টমারের বকেয়া লোন নেই।
      </div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Search functionality
    document.getElementById('searchBox').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      document.querySelectorAll('.customer-card').forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const phone = card.dataset.phone.toLowerCase();
        card.closest('.col-12').style.display = (name.includes(searchTerm) || phone.includes(searchTerm)) ? '' : 'none';
      });
    });
    
    // Mark collected customers
    const collectedToday = JSON.parse(localStorage.getItem('loanCollectedToday_' + new Date().toDateString()) || '[]');
    collectedToday.forEach(id => {
      const card = document.querySelector(`.customer-card[data-id="${id}"]`);
      if (card) card.classList.add('collected');
    });
    
    // Save on form submit
    document.querySelectorAll('.collection-form').forEach(form => {
      form.addEventListener('submit', function() {
        const customerId = this.dataset.customerId;
        if (!collectedToday.includes(customerId)) {
          collectedToday.push(customerId);
          localStorage.setItem('loanCollectedToday_' + new Date().toDateString(), JSON.stringify(collectedToday));
        }
      });
    });
  </script>
</body>
</html>
